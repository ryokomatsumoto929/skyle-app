from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from dotenv import load_dotenv
import os
from datetime import datetime
import requests

# ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿
load_dotenv()

app = FastAPI(
    title="Skyle API",
    description="å¤ªé™½æ™‚åˆ»ã¨å¤©æ°—äºˆå ±ã«ã‚ˆã‚‹å¯è¦–æ€§äºˆæ¸¬API",
    version="1.0.0"
)

# CORSè¨­å®š
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/")
def read_root():
    return {"message": "Skyle API - Ready to predict your golden moments! ğŸŒ…"}

@app.get("/api/solar/times")
def get_solar_times(lat: float = 35.6762, lng: float = 139.6503):
    """å¤ªé™½æ™‚åˆ»å–å¾— (ç°¡æ˜“ç‰ˆ)"""
    try:
        return {
            "sunrise": "06:00",
            "sunset": "18:00",
            "solar_noon": "12:00",
            "golden_hour_morning_start": "05:30",
            "golden_hour_morning_end": "06:00",
            "golden_hour_evening_start": "18:00",
            "golden_hour_evening_end": "18:30",
            "blue_hour_morning_start": "05:00",
            "blue_hour_morning_end": "06:00",
            "blue_hour_evening_start": "18:00",
            "blue_hour_evening_end": "19:00"
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/api/golden-hour-forecast")
def get_golden_hour_forecast(lat: float = 35.6762, lng: float = 139.6503):
    """å¤©æ°—äºˆå ±ã®ã¿ (ãƒ†ã‚¹ãƒˆç‰ˆ)"""
    try:
        return {
            "weather": {
                "temperature": 23.5,
                "humidity": 65,
                "cloud_cover": 45,
                "wind_speed": 3.2,
                "visibility": 10000,
                "weather_main": "Clouds",
                "weather_description": "è–„ã„é›²",
                "pressure": 1013
            },
            "visibility": {
                "level": "good",
                "score": 75,
                "message": "ï¿½ï¿½ ç¾ã—ã„å¤•ç„¼ã‘ãŒæœŸå¾…ã§ããã†ã§ã™",
                "emoji": "ğŸ‘Œ",
                "factors": {
                    "é›²é‡": {"value": "45%", "score": 40, "max": 40},
                    "æ¹¿åº¦": {"value": "65%", "score": 25, "max": 25}
                }
            }
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/api/today-forecast")
def get_today_forecast(lat: float = 35.6762, lng: float = 139.6503):
    """å¤ªé™½æ™‚åˆ» + å¤©æ°—äºˆå ±çµ±åˆ (ãƒ†ã‚¹ãƒˆç‰ˆ)"""
    try:
        solar_times = {
            "sunrise": "06:00",
            "sunset": "18:00",
            "solar_noon": "12:00",
            "golden_hour_evening_start": "18:00",
            "golden_hour_evening_end": "18:30"
        }
        
        weather = {
            "temperature": 23.5,
            "humidity": 65,
            "cloud_cover": 45,
            "wind_speed": 3.2,
            "visibility": 10000,
            "weather_main": "Clouds",
            "weather_description": "è–„ã„é›²"
        }
        
        visibility = {
            "level": "good",
            "score": 75,
            "message": "ï¿½ï¿½ ç¾ã—ã„å¤•ç„¼ã‘ãŒæœŸå¾…ã§ããã†ã§ã™",
            "emoji": "ğŸ‘Œ"
        }
        
        return {
            "solar_times": solar_times,
            "weather": weather,
            "visibility": visibility,
            "location": {"lat": lat, "lng": lng},
            "timestamp": datetime.now().isoformat()
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/api/real-weather-forecast")
def get_real_weather_forecast(lat: float = 35.6762, lng: float = 139.6503):
    """å®Ÿéš›ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹çµ±åˆäºˆå ±"""
    try:
        # APIã‚­ãƒ¼å–å¾—
        api_key = os.getenv("OPENWEATHER_API_KEY")
        if not api_key:
            # APIã‚­ãƒ¼ãŒãªã„å ´åˆã¯ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            return get_today_forecast(lat, lng)
        
        # OpenWeatherMap APIå‘¼ã³å‡ºã—
        weather_url = "https://api.openweathermap.org/data/2.5/weather"
        params = {
            "lat": lat,
            "lon": lng,
            "appid": api_key,
            "units": "metric",  # æ‘‚æ°æ¸©åº¦
            "lang": "ja"        # æ—¥æœ¬èª
        }
        
        print(f"ğŸŒ¤ï¸ OpenWeatherMap APIå‘¼ã³å‡ºã—: lat={lat}, lng={lng}")
        response = requests.get(weather_url, params=params)
        
        if response.status_code != 200:
            print(f"âŒ API Error: {response.status_code}")
            # APIå¤±æ•—æ™‚ã¯ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            return get_today_forecast(lat, lng)
        
        weather_data = response.json()
        print(f"âœ… å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: {weather_data['name']}")
        
        # å®Ÿéš›ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
        real_weather = {
            "temperature": weather_data["main"]["temp"],
            "humidity": weather_data["main"]["humidity"],
            "cloud_cover": weather_data["clouds"]["all"],
            "wind_speed": weather_data["wind"]["speed"],
            "visibility": weather_data.get("visibility", 10000),
            "weather_main": weather_data["weather"][0]["main"],
            "weather_description": weather_data["weather"][0]["description"],
            "pressure": weather_data["main"]["pressure"]
        }
        
        # å¯è¦–æ€§ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿åŸºæº–ï¼‰
        visibility_score = calculate_real_visibility_score(real_weather)
        
        # å¤ªé™½æ™‚åˆ»ï¼ˆç¾åœ¨ã¯ãƒ†ã‚¹ãƒˆç‰ˆï¼‰
        solar_times = {
            "sunrise": "06:00",
            "sunset": "18:00",
            "solar_noon": "12:00",
            "golden_hour_evening_start": "18:00",
            "golden_hour_evening_end": "18:30"
        }
        
        return {
            "solar_times": solar_times,
            "weather": real_weather,
            "visibility": visibility_score,
            "location": {"lat": lat, "lng": lng},
            "timestamp": datetime.now().isoformat(),
            "data_source": "OpenWeatherMap (real-time)",
            "city": weather_data.get("name", "Unknown")
        }
        
    except requests.RequestException as e:
        print(f"ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: {str(e)}")
        # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
        return get_today_forecast(lat, lng)
    except Exception as e:
        print(f"ğŸ’¥ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))

def calculate_real_visibility_score(weather):
    """å®Ÿéš›ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¯è¦–æ€§ã‚’åˆ¤å®š"""
    score = 0
    factors = {}
    
    # é›²é‡ã‚¹ã‚³ã‚¢ (0-40ç‚¹)
    cloud_cover = weather["cloud_cover"]
    if 30 <= cloud_cover <= 70:
        cloud_score = 40
    elif 20 <= cloud_cover <= 80:
        cloud_score = 25
    else:
        cloud_score = 10
    score += cloud_score
    factors["é›²é‡"] = {"value": f"{cloud_cover}%", "score": cloud_score, "max": 40}
    
    # æ¹¿åº¦ã‚¹ã‚³ã‚¢ (0-25ç‚¹)
    humidity = weather["humidity"]
    if 40 <= humidity <= 70:
        humidity_score = 25
    elif 30 <= humidity <= 80:
        humidity_score = 15
    else:
        humidity_score = 5
    score += humidity_score
    factors["æ¹¿åº¦"] = {"value": f"{humidity}%", "score": humidity_score, "max": 25}
    
    # é¢¨é€Ÿã‚¹ã‚³ã‚¢ (0-10ç‚¹)
    wind_speed = weather["wind_speed"]
    if wind_speed <= 3:
        wind_score = 10
    elif wind_speed <= 5:
        wind_score = 7
    else:
        wind_score = 3
    score += wind_score
    factors["é¢¨é€Ÿ"] = {"value": f"{wind_speed}m/s", "score": wind_score, "max": 10}
    
    # è¦–ç¨‹ã‚¹ã‚³ã‚¢ (0-15ç‚¹)
    visibility = weather["visibility"]
    if visibility >= 10000:
        visibility_score = 15
    elif visibility >= 5000:
        visibility_score = 10
    else:
        visibility_score = 5
    score += visibility_score
    factors["è¦–ç¨‹"] = {"value": f"{visibility/1000:.1f}km", "score": visibility_score, "max": 15}
    
    # ãƒ¬ãƒ™ãƒ«åˆ¤å®š
    if score >= 70:
        level, message, emoji = "excellent", "âœ¨ çµ¶å¥½ã®å¤•ç„¼ã‘æ—¥å’Œã§ã™ï¼", "âœ¨"
    elif score >= 50:
        level, message, emoji = "good", "ğŸ‘Œ ç¾ã—ã„å¤•ç„¼ã‘ãŒæœŸå¾…ã§ããã†ã§ã™", "ğŸ‘Œ" 
    elif score >= 30:
        level, message, emoji = "fair", "ğŸ¤” æ¡ä»¶ã¯ã¾ãšã¾ãšã§ã™", "ğŸ¤”"
    else:
        level, message, emoji = "poor", "ğŸ˜” å¤•ç„¼ã‘ã‚’è¦‹ã‚‹ã®ã¯é›£ã—ãã†ã§ã™", "ğŸ˜”"
    
    return {
        "level": level,
        "score": score,
        "message": message,
        "emoji": emoji,
        "factors": factors
    }

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=3001)
